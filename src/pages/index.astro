---
import IndexLayout from '@/layouts/IndexLayout.astro'
import CircularAvatar from '@/components/ui/CircularAvatar.astro'
import Header from '@/components/layout/Header.astro'
import About from '@/components/widgets/About.astro'
import PostList from '@/components/widgets/PostList.astro'
import { themeConfig } from '@/config'
import { getSortedFilteredPostsByTag } from '@/utils/draft';

const caseStudyPosts = await getSortedFilteredPostsByTag('case-study');
const webPosts = await getSortedFilteredPostsByTag('web');
const artPosts = await getSortedFilteredPostsByTag('art');
const hiddenPosts = await getSortedFilteredPostsByTag('hidden');
// const nonTaggedPosts = await getSortedFilteredPostsByTag(true);

// const combinedposts = await [...webPosts, ...webPosts];
---

<IndexLayout title={themeConfig.site.title} description={themeConfig.site.description}>
  <CircularAvatar />
  <div>
    <Header />
  </div>
  <About />
  <main class="main-fade-in">
    <PostList posts={caseStudyPosts} title={"Case Studies"} />
    <PostList posts={webPosts} title={"Writing"} />
    <!-- <PostList posts={artPosts} title={"Writing about Art"} /> -->
    <!-- <PostList posts={hiddenPosts} title={"Hidden articles"} /> -->
    <!-- <PostList posts={nonTaggedPosts} title={"Unfiltered articles"} /> -->
  </main>
</IndexLayout>

<style>
  .main-fade-in {
    opacity: 1;
  }

  @media (min-width: 769px) {
    .main-fade-in {
      opacity: 0;
      transition: opacity 0.6s ease-out;
    }

    .main-fade-in.is-visible {
      opacity: 1;
    }

    /* On navigation, skip animation */
    body.is-navigation .main-fade-in {
      opacity: 1;
      transition: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .main-fade-in {
      opacity: 1;
      transition: none;
    }
  }
</style>

<script>
  function initMainFadeIn() {
    const main = document.querySelector('.main-fade-in');
    if (!main) return;

    // Skip if navigation (already visible via CSS)
    if (document.body.classList.contains('is-navigation')) {
      main.classList.add('is-visible');
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Delay to sync with other page animations
            setTimeout(() => {
              entry.target.classList.add('is-visible');
            }, 1800); // note to me: I pulled this number from old CSS delay, this should line up with reveal anims
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1 }
    );

    observer.observe(main);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMainFadeIn);
  } else {
    initMainFadeIn();
  }
  document.addEventListener('astro:page-load', initMainFadeIn);
</script>
